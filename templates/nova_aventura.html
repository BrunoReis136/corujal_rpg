{% extends "base.html" %}

{% block title %}
  {% if editando %}Editar Aventura{% else %}Nova Aventura{% endif %} - RPG
{% endblock %}

{% block content %}
<div class="flex flex-col items-center justify-center h-full">
  <h2 class="text-2xl font-bold text-yellow-300 mb-6">
    {% if editando %}‚úèÔ∏è Editar Aventura{% else %}‚ú® Criar Nova Aventura{% endif %}
  </h2>

  <div class="bg-gray-800 p-6 rounded-xl shadow-lg w-full max-w-lg">
    <form method="post" class="space-y-4">
      {{ form.hidden_tag() }}

      <!-- t√≠tulo -->
      <div>
        {{ form.titulo.label(class="block mb-1 text-yellow-300") }}
        {{ form.titulo(class="w-full p-2 rounded-lg bg-gray-700 text-white") }}
      </div>

      <!-- descri√ß√£o -->
      <div>
        {{ form.descricao.label(class="block mb-1 text-yellow-300") }}
        {{ form.descricao(class="w-full p-2 rounded-lg bg-gray-700 text-white", placeholder="Ex:Num mundo sombrio com vampiros, um ca√ßador de monstros busca vingan√ßa pela sua fam√≠lia...") }}
      </div>

      <!-- cen√°rio -->
      <div>
        {{ form.cenario.label(class="block mb-1 text-yellow-300") }}
        {{ form.cenario(class="w-full p-2 rounded-lg bg-gray-700 text-white", placeholder="Ex: Vampiro A M√°scara, Fantasia Medieval, Apocalipse Zumbi...") }}
      </div>

      <!-- status -->
      <div>
        {{ form.status.label(class="block mb-1 text-yellow-300") }}
        {{ form.status(class="w-full p-2 rounded-lg bg-gray-700 text-white") }}
      </div>

      <!-- regras -->
      <div>
        <label class="block mb-2 text-yellow-300 text-lg font-bold">üé≤ Regras de Rolagem de Dados</label>
      
        <div class="flex flex-col gap-3">
          <!-- Erro Cr√≠tico -->
          <div>
            <label class="block text-gray-300 text-sm mb-1 flex items-center gap-2">
              üíÄ Erro Cr√≠tico (m√°x.)
            </label>
            <div class="flex items-center gap-2">
              <button type="button" class="px-2 py-1 bg-gray-600 text-white rounded hover:bg-gray-500" data-target="erro_critico_max" data-action="decrease">‚àí</button>
              {{ form.erro_critico_max(class="w-full p-2 rounded-lg bg-gray-700 text-white text-center", id="erro_critico_max", type="number", min="1", max="100") }}
              <button type="button" class="px-2 py-1 bg-gray-600 text-white rounded hover:bg-gray-500" data-target="erro_critico_max" data-action="increase">+</button>
            </div>
          </div>
      
          <!-- Erro Normal -->
          <div>
            <label class="block text-gray-300 text-sm mb-1 flex items-center gap-2">
              ‚ùå Erro Normal (m√°x.)
            </label>
            <div class="flex items-center gap-2">
              <button type="button" class="px-2 py-1 bg-gray-600 text-white rounded hover:bg-gray-500" data-target="erro_normal_max" data-action="decrease">‚àí</button>
              {{ form.erro_normal_max(class="w-full p-2 rounded-lg bg-gray-700 text-white text-center", id="erro_normal_max", type="number", min="1", max="100") }}
              <button type="button" class="px-2 py-1 bg-gray-600 text-white rounded hover:bg-gray-500" data-target="erro_normal_max" data-action="increase">+</button>
            </div>
          </div>
      
          <!-- Acerto Normal -->
          <div>
            <label class="block text-gray-300 text-sm mb-1 flex items-center gap-2">
              ‚úÖ Acerto Normal (m√°x.)
            </label>
            <div class="flex items-center gap-2">
              <button type="button" class="px-2 py-1 bg-gray-600 text-white rounded hover:bg-gray-500" data-target="acerto_normal_max" data-action="decrease">‚àí</button>
              {{ form.acerto_normal_max(class="w-full p-2 rounded-lg bg-gray-700 text-white text-center", id="acerto_normal_max", type="number", min="1", max="100") }}
              <button type="button" class="px-2 py-1 bg-gray-600 text-white rounded hover:bg-gray-500" data-target="acerto_normal_max" data-action="increase">+</button>
            </div>
          </div>
      
          <!-- Campo oculto -->
          {{ form.acerto_critico_min(type="hidden", id="acerto_critico_min") }}
        </div>
      
        <p class="text-xs text-gray-400 mt-2">
          ‚öôÔ∏è As faixas de valores ser√£o ajustadas automaticamente para manter consist√™ncia (1‚Äì100).
        </p>
      
        <!-- Faixa visual -->
        <div class="mt-4 w-full bg-gray-700 rounded-full h-5 relative overflow-hidden">
          <div id="bar-erro-critico" class="absolute left-0 top-0 h-full bg-red-600"></div>
          <div id="bar-erro-normal" class="absolute top-0 h-full bg-yellow-500"></div>
          <div id="bar-acerto-normal" class="absolute top-0 h-full bg-green-600"></div>
          <div id="bar-acerto-critico" class="absolute top-0 h-full bg-blue-600"></div>
        </div>
      
        <div class="flex justify-between text-xs text-gray-300 mt-1">
          <span>1</span>
          <span>100</span>
        </div>
      
        <div class="flex justify-between text-sm text-gray-400 mt-1">
          <span>üíÄ Falha Cr√≠tica</span>
          <span>‚ùå Falha</span>
          <span>‚úÖ Acerto</span>
          <span>üåü Cr√≠tico</span>
        </div>
      </div>



      <!-- bot√µes -->
      <div class="flex gap-4">
        {{ form.submit(class="flex-1 bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg") }}
        <a href="{{ url_for('lista_aventuras') }}"
           class="flex-1 text-center bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded-lg">
          ‚Ü©Ô∏è Voltar
        </a>
      </div>
    </form>
  </div>
</div>
{% endblock %}

{% block scripts %}

<script>
document.addEventListener("DOMContentLoaded", () => {
  const erroCritico = document.getElementById("erro_critico_max");
  const erroNormal = document.getElementById("erro_normal_max");
  const acertoNormal = document.getElementById("acerto_normal_max");
  const acertoCritico = document.getElementById("acerto_critico_min");

  const barEC = document.getElementById("bar-erro-critico");
  const barEN = document.getElementById("bar-erro-normal");
  const barAN = document.getElementById("bar-acerto-normal");
  const barAC = document.getElementById("bar-acerto-critico");

  function ajustarValores() {
    let eCrit = parseInt(erroCritico.value) || 15;
    let eNorm = parseInt(erroNormal.value) || (eCrit + 30);
    let aNorm = parseInt(acertoNormal.value) || (eNorm + 35);

    if (eNorm <= eCrit) eNorm = eCrit + 1;
    if (aNorm <= eNorm) aNorm = eNorm + 1;
    if (aNorm > 99) aNorm = 99;

    const aCrit = 100;

    erroCritico.value = eCrit;
    erroNormal.value = eNorm;
    acertoNormal.value = aNorm;
    acertoCritico.value = aCrit;

    atualizarFaixa(eCrit, eNorm, aNorm, aCrit);
  }

  function atualizarFaixa(eCrit, eNorm, aNorm, aCrit) {
    const total = 100;
    const wEC = (eCrit / total) * 100;
    const wEN = ((eNorm - eCrit) / total) * 100;
    const wAN = ((aNorm - eNorm) / total) * 100;
    const wAC = ((100 - aNorm) / total) * 100;

    barEC.style.width = `${wEC}%`;
    barEN.style.left = `${wEC}%`;
    barEN.style.width = `${wEN}%`;
    barAN.style.left = `${wEC + wEN}%`;
    barAN.style.width = `${wAN}%`;
    barAC.style.left = `${wEC + wEN + wAN}%`;
    barAC.style.width = `${wAC}%`;
  }

  function alterarValor(target, action) {
    const el = document.getElementById(target);
    let value = parseInt(el.value) || 0;

    if (action === "increase" && value < 100) value++;
    if (action === "decrease" && value > 1) value--;

    el.value = value;
    ajustarValores();
  }

  // Bot√µes +/‚àí com suporte a clique e segurar
  document.querySelectorAll("button[data-target]").forEach(btn => {
    let interval;
    const target = btn.dataset.target;
    const action = btn.dataset.action;

    const start = () => {
      alterarValor(target, action);
      interval = setInterval(() => alterarValor(target, action), 120); // repete a cada 120ms
    };
    const stop = () => clearInterval(interval);

    btn.addEventListener("mousedown", start);
    btn.addEventListener("touchstart", start);

    btn.addEventListener("mouseup", stop);
    btn.addEventListener("mouseleave", stop);
    btn.addEventListener("touchend", stop);
  });

  [erroCritico, erroNormal, acertoNormal].forEach(el => {
    el.addEventListener("input", ajustarValores);
  });

  ajustarValores(); // inicial
});
</script>


{% endblock %}
