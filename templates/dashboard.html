{% extends "base.html" %}

{% block title %}Dashboard do Jogador{% endblock %}

{% block content %}
<div class="flex flex-col h-full w-full px-6 py-4 space-y-4 text-base sm:text-lg">
  <h2 class="text-2xl sm:text-3xl font-bold text-yellow-300 mb-2">üìú Aventura em andamento</h2>

  <!-- √Årea de exibi√ß√£o dos turnos -->
  <div id="turno-historico" class="bg-gray-900 text-gray-150 p-4 rounded-lg shadow-md h-[70vh] overflow-y-auto text-sm sm:text-base">
    {% if not personagem %}
      <h2 class="text-xl sm:text-2xl font-bold text-yellow-300 mb-4">üßù‚Äç‚ôÇÔ∏è Pra come√ßar, vamos criar um personagem!</h2>
      <form method="POST" action="{{ url_for('criar_personagem') }}" class="space-y-4">
        {{ personagem_form.hidden_tag() }}
        <div>
          {{ personagem_form.nome.label(class_="text-gray-200 text-sm sm:text-base") }}
          {{ personagem_form.nome(class_="w-full p-2 rounded bg-gray-700 text-white text-sm sm:text-base") }}
        </div>
        <div>
          {{ personagem_form.classe.label(class_="text-gray-200 text-sm sm:text-base") }}
          {{ personagem_form.classe(class_="w-full p-2 rounded bg-gray-700 text-white text-sm sm:text-base") }}
        </div>
        <div>
          {{ personagem_form.raca.label(class_="text-gray-200 text-sm sm:text-base") }}
          {{ personagem_form.raca(class_="w-full p-2 rounded bg-gray-700 text-white text-sm sm:text-base") }}
        </div>
        <div>
          {{ personagem_form.descricao.label(class_="text-gray-200 text-sm sm:text-base") }}
          {{ personagem_form.descricao(class_="w-full p-2 rounded bg-gray-700 text-white text-sm sm:text-base") }}
        </div>

        <!-- Atributos -->
        <div class="grid grid-cols-3 gap-4">
          {% for attr, label in [('forca','For√ßa'),('destreza','Destreza'),('inteligencia','Intelig√™ncia')] %}
          <div>
            <label class="block text-sm sm:text-base font-medium text-gray-200">{{ label }}</label>
            <div class="flex items-center gap-2">
              <button type="button" data-attr="{{ attr }}" data-delta="-1" class="bg-gray-700 px-2 rounded text-sm sm:text-base">‚àí</button>
              <input id="{{ attr }}_modal" name="{{ attr }}" type="number" value="50" min="1" max="99"
                     class="w-16 text-center rounded bg-gray-700 text-white text-sm sm:text-base" readonly>
              <button type="button" data-attr="{{ attr }}" data-delta="1" class="bg-gray-700 px-2 rounded text-sm sm:text-base">+</button>
            </div>
          </div>
          {% endfor %}
        </div>
  
        <p class="mt-2 text-yellow-400 font-bold text-sm sm:text-base">
          Pontos restantes: <span id="pontos-restantes-modal">50</span>
        </p>


        <div>
          <button type="submit" name="criar_personagem" class="w-full bg-green-500 text-black font-bold py-2 rounded hover:bg-green-400 transition text-sm sm:text-base">
            Criar personagem e iniciar aventura
          </button>
        </div>
      </form>
    {% else %}
      <!-- Exibi√ß√£o do hist√≥rico de mensagens -->
      <div id="turno-historico-inner" class="space-y-4 px-2 sm:px-4">
        {% for msg in mensagens %}
          {% set eh_mestre = (msg.autor == "Mestre IA") %}
          <div class="flex {% if eh_mestre %}justify-start{% else %}justify-end{% endif %}">
            <div class="max-w-[85%] sm:max-w-[75%] rounded-xl px-3 py-2
                        {% if eh_mestre %}
                          bg-gray-700 text-gray-100 text-left
                        {% else %}
                          bg-yellow-500 text-black text-right
                        {% endif %}">
              <p class="text-sm md:text-base lg:text-lg mb-1 {% if eh_mestre %}text-gray-300{% else %}text-black{% endif %}">
                {{ msg.criado_em.strftime('%d/%m %H:%M') }} -
                <span class="font-bold {% if eh_mestre %}text-yellow-400{% else %}text-black{% endif %}">
                  {{ msg.autor }}
                </span>
              </p>
              <p class="text-base sm:text-lg md:text-xl lg:text-2xl xl:text-3xl leading-relaxed break-words whitespace-pre-line">
                {{ msg.mensagem }}
              </p>

            </div>
          </div>
        {% endfor %}
      </div>

    {% endif %}
  </div>
</div>
{% endblock %}

{% block sidebar %}
<div class="relative flex flex-col h-full gap-4 p-4 bg-gray-800 rounded-xl shadow-md overflow-y-auto text-sm sm:text-base">

  <!-- Formul√°rio de entrada -->
<form id="form-turno" method="POST" action="{{ url_for('enviar_turno') }}" class="space-y-3">
  {{ form.hidden_tag() }}
  <div>
    {{ form.acao.label(class_="text-gray-200") }}
    {{ form.acao(class_="w-full p-2 rounded-lg bg-gray-700 text-gray-200", placeholder="O que seu personagem faz?") }}
  </div>
  <div>
    {{ form.contexto.label(class_="text-gray-200") }}
    {{ form.contexto(class_="w-full p-2 rounded-lg bg-gray-700 text-gray-200", placeholder="Informa√ß√µes adicionais ao mestre...") }}
  </div>

  <!-- Faixa de refer√™ncia -->
  <div class="bg-gray-700 rounded-lg p-3 mb-3 text-sm text-gray-200">
    <p class="font-bold text-yellow-400 mb-1">Faixa de resultados</p>
    <div class="space-y-1">
      <p>üíÄ <strong>Falha Cr√≠tica:</strong> at√© {{ aventura.regras["erro_critico_max"] }}</p>
      <p>‚ùå <strong>Falha:</strong> at√© {{ aventura.regras["erro_normal_max"] }}</p>
      <p>‚úÖ <strong>Sucesso:</strong> at√© {{ aventura.regras["acerto_normal_max"] }}</p>
      <p>üåü <strong>Sucesso Cr√≠tico:</strong> acima de {{ aventura.regras["acerto_normal_max"] }}</p>
    </div>
  </div>
  
  <!-- Personagens na cena -->
  <details class="bg-gray-700 rounded-md p-2 mt-2">
    <summary class="cursor-pointer font-bold text-yellow-400 text-sm sm:text-base">üé≠ Personagens na cena</summary>
    {% if personagens %}
      <ul class="list-disc list-inside ml-4 mt-2 text-sm sm:text-base">
        {% for p in personagens %}
          <li class="flex items-center gap-2">
            <input type="checkbox" name="personagem_{{ p.id }}" id="personagem_{{ p.id }}" {% if p.ativo_na_sessao %}checked{% endif %}>
            <label for="personagem_{{ p.id }}">{{ p.nome }} ({{ p.classe }})</label>
          </li>
        {% endfor %}
      </ul>
      <p class="mt-2 text-gray-300 text-xs sm:text-sm">Marque os personagens que est√£o em cena. As altera√ß√µes ser√£o registradas ao enviar o turno.</p>
    {% else %}
      <p class="text-gray-300 text-sm sm:text-base">Nenhum personagem criado.</p>
    {% endif %}
  </details>

  <!-- Rolar Dados -->
  <div id="rolar-dados" class="bg-gray-800 p-4 rounded-xl mt-4 shadow-md">
    <h3 class="text-lg font-bold text-yellow-300 mb-2">üé≤ Rolar Dados</h3>

    <div id="dados-lista" class="space-y-3">
      <!-- Cada rolagem aparecer√° aqui -->
    </div>

    <button type="button" id="add-dado"
      class="w-full bg-yellow-500 hover:bg-yellow-600 text-black font-bold py-2 rounded-lg mt-3">
      ‚ûï Adicionar Rolagem
    </button>
  </div>

  <div>
    {{ form.submit(class_="w-full bg-yellow-400 text-black font-bold py-2 rounded-lg hover:bg-yellow-300 transition") }}
  </div>
</form>


  
  <!-- Acorde√µes -->
  <div class="space-y-2">
    <!-- Personagens -->
    <details class="bg-gray-700 rounded-md p-2">
      <summary class="cursor-pointer font-bold text-yellow-400 text-sm sm:text-base">üßù Personagens</summary>
      {% if personagens %}
        {% for p in personagens %}
          <div class="mb-3 border-b border-gray-600 pb-2 text-sm sm:text-base">
            <p><strong>Nome:</strong> {{ p.nome }}</p>
            <p><strong>Classe:</strong> {{ p.classe }}</p>
            <p><strong>Ra√ßa:</strong> {{ p.raca }}</p>
            <p><strong>N√≠vel:</strong> {{ p.nivel }} (XP: {{ p.xp }})</p>
            <p><strong>Atributos:</strong></p>
            <ul class="list-disc ml-4">
              {% for key, val in p.atributos.items() %}
                <li>{{ key }}: {{ val }}</li>
              {% endfor %}
            </ul>
            <p><strong>Descri√ß√£o:</strong> {{ p.descricao or '---' }}</p>
            <div class="mt-2 flex gap-2">
              <button type="button"
                onclick="abrirModalEdicao(
                  {{ p.id }},
                  {{ p.nome|tojson }},
                  {{ p.classe|tojson }},
                  {{ p.raca|tojson }},
                  {{ (p.descricao or '')|tojson }},
                  {{ p.atributos['For√ßa'] }},
                  {{ p.atributos['Destreza'] }},
                  {{ p.atributos['Intelig√™ncia'] }}
                )"
                class="bg-blue-600 text-white px-3 py-1 rounded hover:bg-blue-500 text-sm sm:text-base">
                Alterar
              </button>
              <form method="POST" action="{{ url_for('excluir_personagem', personagem_id=p.id) }}"
                    onsubmit="return confirm('Tem certeza que deseja excluir este personagem?')">
                <button type="submit"
                        class="bg-red-600 text-white px-3 py-1 rounded hover:bg-red-500 text-sm sm:text-base">
                  Excluir
                </button>
              </form>
            </div>
          </div>
        {% endfor %}
      {% else %}
        <p class="text-gray-300 text-sm sm:text-base">Nenhum personagem associado.</p>
      {% endif %}
      <button type="button" onclick="abrirModalNovo()"
        class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-500 mt-2 text-sm sm:text-base">
        + Novo Personagem
      </button>

    </details>

    <!-- Invent√°rio -->
    <details class="bg-gray-700 rounded-md p-2">
      <summary class="cursor-pointer font-bold text-yellow-400 text-sm sm:text-base">üéí Invent√°rio</summary>
      {% if personagem and personagem.inventario %}
        <ul class="list-disc ml-4 text-sm sm:text-base">
          {% for item in personagem.inventario %}
            <li>{{ item }}</li>
          {% endfor %}
        </ul>
      {% else %}
        <p class="text-gray-300 text-sm sm:text-base">Sem itens.</p>
      {% endif %}
    </details>

    <!-- Aventura -->
    <details class="bg-gray-700 rounded-md p-2">
      <summary class="cursor-pointer font-bold text-yellow-400 text-sm sm:text-base">üó∫Ô∏è Aventura</summary>
      {% if aventura %}
        <p><strong>T√≠tulo:</strong> {{ aventura.titulo }}</p>
        <p><strong>Cen√°rio:</strong> {{ aventura.cenario }}</p>
        <p><strong>Status:</strong> {{ aventura.status }}</p>
        <p><strong>Resumo:</strong> {{ aventura.resumo_atual }}</p>
      {% else %}
        <p class="text-gray-300 text-sm sm:text-base">Nenhuma aventura ativa.</p>
      {% endif %}
    </details>

    <!-- Hist√≥rico -->
    <details class="bg-gray-700 rounded-md p-2">
      <summary class="cursor-pointer font-bold text-yellow-400 text-sm sm:text-base">üìö Hist√≥rico</summary>
      <p>Mensagens: {{ mensagens|length }}</p>
      <p>√öltimo turno: {{ ultima_sessao.criado_em.strftime('%d/%m %H:%M') if ultima_sessao else '---' }}</p>
    </details>
    
    <!-- Bot√£o voltar para aventuras -->
    <div class="mt-4">
      <a href="{{ url_for('lista_aventuras') }}"
         class="block w-full text-center bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded transition text-sm sm:text-base">
        ‚¨Ö Voltar para a lista de aventuras
      </a>
    </div>
  </div>

  <!-- Overlay lateral da sidebar -->
  <div id="sidebar-loading-overlay"
       class="absolute inset-0 bg-black bg-opacity-70 flex flex-col items-center justify-center z-50
              transform transition-transform duration-700 ease-out
              {% if not personagem %}translate-x-0{% else %}translate-x-full hidden{% endif %}">
    <img src="{{ url_for('static', filename='img/loading.gif') }}" alt="Carregando..." class="w-20 h-20 mb-3">
    {% if not personagem %}
      <p class="text-yellow-300 text-lg font-bold animate-pulse">Carregando aventura...</p>
    {% else %}
      <p class="text-yellow-300 text-sm font-semibold">Processando turno...</p>
    {% endif %}
  </div>
  
</div>


<!-- Modal de personagem -->
<div id="modal-personagem" class="hidden fixed inset-0 bg-black bg-opacity-70 flex justify-center items-center z-50">
  <div class="bg-gray-800 rounded-lg p-6 w-full max-w-md relative">
    <h2 id="modal-titulo" class="text-xl font-bold text-yellow-300 mb-4">üßù‚Äç‚ôÇÔ∏è Novo Personagem</h2>
    
    <form id="form-personagem" method="POST" action="{{ url_for('add_personagem') }}" class="space-y-4">
      {{ personagem_form.hidden_tag() }}
      <input type="hidden" id="personagem_modal_id" name="personagem_id">

      <div>
        {{ personagem_form.nome.label(class_="text-gray-200 text-sm sm:text-base") }}
        {{ personagem_form.nome(id="nome_modal", class_="w-full p-2 rounded bg-gray-700 text-white text-sm sm:text-base") }}
      </div>

      <div>
        {{ personagem_form.classe.label(class_="text-gray-200 text-sm sm:text-base") }}
        {{ personagem_form.classe(id="classe_modal", class_="w-full p-2 rounded bg-gray-700 text-white text-sm sm:text-base") }}
      </div>

      <div>
        {{ personagem_form.raca.label(class_="text-gray-200 text-sm sm:text-base") }}
        {{ personagem_form.raca(id="raca_modal", class_="w-full p-2 rounded bg-gray-700 text-white text-sm sm:text-base") }}
      </div>

      <div>
        {{ personagem_form.descricao.label(class_="text-gray-200 text-sm sm:text-base") }}
        {{ personagem_form.descricao(id="descricao_modal", class_="w-full p-2 rounded bg-gray-700 text-white text-sm sm:text-base") }}
      </div>

      <!-- Atributos -->
      <div class="grid grid-cols-3 gap-4">
        {% for attr, label in [('forca','For√ßa'),('destreza','Destreza'),('inteligencia','Intelig√™ncia')] %}
        <div>
          <label class="block text-sm sm:text-base font-medium text-gray-200">{{ label }}</label>
          <div class="flex items-center gap-2">
            <button type="button" data-attr="{{ attr }}" data-delta="-1" class="bg-gray-700 px-2 rounded text-sm sm:text-base">‚àí</button>
            <input id="{{ attr }}_modal" name="{{ attr }}" type="number" value="50" min="1" max="99"
                   class="w-16 text-center rounded bg-gray-700 text-white text-sm sm:text-base" readonly>
            <button type="button" data-attr="{{ attr }}" data-delta="1" class="bg-gray-700 px-2 rounded text-sm sm:text-base">+</button>
          </div>
        </div>
        {% endfor %}
      </div>


      <p class="mt-2 text-yellow-400 font-bold text-sm sm:text-base">
        Pontos restantes: <span id="pontos-restantes-modal">50</span>
      </p>

      <div class="flex justify-between mt-4">
        <button type="button"
                onclick="fecharModalPersonagem()"
                class="bg-gray-600 text-white px-4 py-2 rounded hover:bg-gray-500">
          Cancelar
        </button>
        <button type="submit"
                id="botao-salvar"
                class="bg-green-500 text-black font-bold px-4 py-2 rounded hover:bg-green-400">
          Criar personagem
        </button>
      </div>
    </form>
  </div>
</div>



{% endblock %}

{% block scripts %}
<script>
document.addEventListener("DOMContentLoaded", () => {
  
  const historico = document.getElementById("turno-historico");
    if (historico) {
      historico.scrollTop = historico.scrollHeight;
    }
  
  const lista = document.getElementById("dados-lista");
  const addBtn = document.getElementById("add-dado");

  // As regras da aventura s√£o injetadas via Jinja (precisam estar dispon√≠veis fora da fun√ß√£o)
  const regras = {{ aventura.regras | tojson | safe }};

  function criarRolagem() {
    const div = document.createElement("div");
    div.className = "flex flex-wrap gap-2 items-center bg-gray-700 p-3 rounded-lg";

    // HTML da rolagem
    div.innerHTML = `
      <select class="personagem-select bg-gray-800 text-white rounded p-2 flex-1">
        <option value="">Selecione o personagem</option>
        {% for p in personagens %}
          <option value="{{ p.id }}" 
                  data-forca="{{ p.atributos['For√ßa'] }}" 
                  data-destreza="{{ p.atributos['Destreza'] }}" 
                  data-inteligencia="{{ p.atributos['Intelig√™ncia'] }}">
            {{ p.nome }}
          </option>
        {% endfor %}
      </select>
      
      <select class="tipo-rolagem bg-gray-800 text-white rounded p-2 flex-1">
        <option value="forca">For√ßa</option>
        <option value="destreza">Destreza</option>
        <option value="inteligencia">Intelig√™ncia</option>
      </select>

      <button type="button" class="rolar bg-green-600 hover:bg-green-700 text-white font-bold px-3 py-2 rounded">
        üé≤ Rolar
      </button>

      <span class="resultado text-yellow-300 font-mono ml-2">‚Äî</span>

      <button type="button" class="remover bg-red-600 hover:bg-red-700 text-white px-2 py-1 rounded">
        ‚úñ
      </button>
    `;

    // Evento rolar
    div.querySelector(".rolar").addEventListener("click", () => {
      const personagemSel = div.querySelector(".personagem-select");
      const tipoRolagem = div.querySelector(".tipo-rolagem").value;
      const resultadoEl = div.querySelector(".resultado");
    
      if (!personagemSel.value || !tipoRolagem) {
        alert("Selecione o personagem e o tipo de rolagem!");
        return;
      }
    
      // Rolagem base (1‚Äì100)
      const valorBase = Math.floor(Math.random() * 100) + 1;
    
      // Pega o atributo selecionado (For√ßa, Destreza ou Intelig√™ncia)
      let atributo = parseInt(personagemSel.selectedOptions[0].dataset[tipoRolagem]);
      if (isNaN(atributo)) atributo = 50;
    
      // Calcula b√¥nus com base no desvio do valor m√©dio 50
      let bonus = Math.floor((atributo - 50) / 2);
    
      // Valor final limitado entre 1 e 100
      let valorFinal = Math.min(Math.max(valorBase + bonus, 1), 100);
    
      // Determina o resultado segundo as regras
      let texto = "";
      if (valorFinal <= regras.erro_critico_min) texto = "üíÄ Falha Cr√≠tica";
      else if (valorFinal <= regras.erro_normal_max) texto = "‚ùå Falha";
      else if (valorFinal <= regras.acerto_normal_max) texto = "‚úÖ Sucesso";
      else texto = "üåü Sucesso Cr√≠tico";
    
      // Exibe o resultado formatado
      resultadoEl.textContent = `${valorFinal} ‚Äî ${texto} (${tipoRolagem} ${bonus >= 0 ? "+" : ""}${bonus})`;
      resultadoEl.dataset.valor = valorFinal;
      resultadoEl.dataset.texto = texto;
    });

    // Bot√£o para remover rolagem
    div.querySelector(".remover").addEventListener("click", () => div.remove());

    lista.appendChild(div);
  }

  // Evento do bot√£o "+"
  addBtn.addEventListener("click", criarRolagem);
});

  document.addEventListener("DOMContentLoaded", () => {
  const form = document.getElementById("form-turno");
  const historico = document.getElementById("turno-historico-inner");
  const overlay = document.getElementById("sidebar-loading-overlay");

  if (!form) return;

  form.addEventListener("submit", async (e) => {
    e.preventDefault();
  
    overlay.classList.remove("hidden");
    overlay.classList.remove("translate-x-full");
    overlay.classList.add("translate-x-0");
  
    try {
      const formData = new FormData(form);
  
      // Monta tamb√©m as rolagens (dados visuais da se√ß√£o "üé≤ Rolar Dados")
      const rolagens = [];
      document.querySelectorAll("#dados-lista > div").forEach((div) => {
        const personagemSel = div.querySelector(".personagem-select");
        const tipo = div.querySelector(".tipo-rolagem")?.value;
        const resultadoEl = div.querySelector(".resultado");
        if (personagemSel?.value && tipo && resultadoEl?.dataset?.valor) {
          rolagens.push({
            personagem_id: personagemSel.value,
            personagem_nome: personagemSel.selectedOptions[0].textContent.trim(),
            tipo: tipo,
            valor: resultadoEl.dataset.valor,
            texto: resultadoEl.dataset.texto,
          });
        }
      });
  
      // Inclui as rolagens como JSON
      formData.append("rolagens", JSON.stringify(rolagens));
  
      const response = await fetch(form.action, {
        method: "POST",
        headers: {
          "X-Requested-With": "XMLHttpRequest" // para Flask saber que √© AJAX
        },
        body: formData,
      });
  
      const result = await response.json();
  
      if (result.status !== "ok") {
        alert(result.error || "Erro ao processar turno.");
        return;
      }
  
      // Atualiza o hist√≥rico de mensagens
      const historico = document.getElementById("turno-historico");
      historico.innerHTML = "";
  
      result.mensagens.forEach((msg) => {
        const ehMestre = msg.autor === "Mestre IA";
        const div = document.createElement("div");
        div.className = `flex ${ehMestre ? "justify-start" : "justify-end"}`;
        div.innerHTML = `
          <div class="max-w-[85%] sm:max-w-[75%] rounded-xl px-3 py-2
                      ${ehMestre ? "bg-gray-700 text-gray-100 text-left" : "bg-yellow-500 text-black text-right"}">
            <p class="text-sm md:text-base lg:text-lg mb-1 ${ehMestre ? "text-gray-300" : "text-black"}">
              ${msg.criado_em} -
              <span class="font-bold ${ehMestre ? "text-yellow-400" : "text-black"}">${msg.autor}</span>
            </p>
            <p class="text-base sm:text-lg md:text-xl lg:text-2xl xl:text-3xl leading-relaxed break-words">${msg.mensagem}</p>
          </div>`;
        historico.appendChild(div);
      });
  
      // Rola para o fim
      historico.scrollTop = historico.scrollHeight;
  
      // Limpa a√ß√£o e contexto do formul√°rio
      form.reset();
      document.getElementById("dados-lista").innerHTML = "";
  
    } catch (err) {
      console.error(err);
      alert("Erro ao enviar turno.");
    } finally {
      // Oculta o overlay de carregamento
      overlay.classList.add("translate-x-full");
      setTimeout(() => overlay.classList.add("hidden"), 600);
    }
  });

  // Rolar para o fim ao carregar
  const scrollHistorico = document.getElementById("turno-historico");
  if (scrollHistorico) {
    scrollHistorico.scrollTop = scrollHistorico.scrollHeight;
  }
});


let holdTimeout = null;
let holdActive = false;

function ajustarAtributo(attr, delta) {
  const input = document.getElementById(attr + '_modal');
  let valor = parseInt(input.value) || 0;
  let pontosRestantes = parseInt(document.getElementById('pontos-restantes-modal').innerText);

  if (delta > 0 && pontosRestantes > 0 && valor < 99) {
    valor += 1;
    pontosRestantes -= 1;
  } else if (delta < 0 && valor > 1) {
    valor -= 1;
    pontosRestantes += 1;
  }

  input.value = valor;
  document.getElementById('pontos-restantes-modal').innerText = pontosRestantes;
}

function iniciarPress(attr, delta) {
  ajustarAtributo(attr, delta); // aplica imediatamente
  holdActive = true;

  let delay = 300; // in√≠cio mais lento

  function repetir() {
    if (!holdActive) return;
    ajustarAtributo(attr, delta);
    delay = Math.max(50, delay * 0.9); // acelera gradualmente
    holdTimeout = setTimeout(repetir, delay);
  }

  holdTimeout = setTimeout(repetir, delay);
}

function pararPress() {
  holdActive = false;
  clearTimeout(holdTimeout);
}

document.addEventListener('DOMContentLoaded', () => {
  document.querySelectorAll('button[data-attr]').forEach(btn => {
    const attr = btn.dataset.attr;
    const delta = parseInt(btn.dataset.delta);

    btn.addEventListener('mousedown', () => iniciarPress(attr, delta));
    btn.addEventListener('mouseup', pararPress);
    btn.addEventListener('mouseleave', pararPress);

    btn.addEventListener('touchstart', e => {
      e.preventDefault(); // evita clique duplo em mobile
      iniciarPress(attr, delta);
    });
    btn.addEventListener('touchend', pararPress);
  });
});

  
function abrirModalNovo() {
  document.getElementById('modal-titulo').innerText = 'üßù‚Äç‚ôÇÔ∏è Novo Personagem';
  document.getElementById('botao-salvar').innerText = 'Criar personagem';
  document.getElementById('form-personagem').action = "{{ url_for('add_personagem') }}";
  document.getElementById('personagem_modal_id').value = '';

  // resetar campos
  ['nome_modal','classe_modal','raca_modal','descricao_modal'].forEach(id => {
    const el = document.getElementById(id);
    if (el) el.value = '';
  });
  ['forca','destreza','inteligencia'].forEach(a => {
    const el = document.getElementById(a + '_modal');
    if (el) el.value = 50;
  });

  // recalcula pontos restantes (limite total = 200)
  const pontosRest = 200 - (50 + 50 + 50);
  document.getElementById('pontos-restantes-modal').innerText = pontosRest;

  document.getElementById('modal-personagem').classList.remove('hidden');
}

function abrirModalEdicao(id, nome, classe, raca, descricao, forca, destreza, inteligencia) {
  document.getElementById('modal-titulo').innerText = '‚úèÔ∏è Editar Personagem';
  document.getElementById('botao-salvar').innerText = 'Salvar altera√ß√µes';
  // manter sempre a mesma rota add_personagem (o backend decide criar/editar via personagem_id)
  document.getElementById('form-personagem').action = "{{ url_for('add_personagem') }}";
  document.getElementById('personagem_modal_id').value = id;

  // preencher campos (garanta que os elementos existam)
  document.getElementById('nome_modal').value = nome || '';
  document.getElementById('classe_modal').value = classe || '';
  document.getElementById('raca_modal').value = raca || '';
  document.getElementById('descricao_modal').value = descricao || '';
  document.getElementById('forca_modal').value = forca ?? 50;
  document.getElementById('destreza_modal').value = destreza ?? 50;
  document.getElementById('inteligencia_modal').value = inteligencia ?? 50;

  // recalcula pontos restantes
  const pontosRest = Math.max(0, 200 - (Number(forca) + Number(destreza) + Number(inteligencia)));
  document.getElementById('pontos-restantes-modal').innerText = pontosRest;

  document.getElementById('modal-personagem').classList.remove('hidden');
}
function fecharModalPersonagem() {
  document.getElementById('modal-personagem').classList.add('hidden');
}
</script>

{% endblock %}
