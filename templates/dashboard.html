{% extends "base.html" %}

{% block title %}Dashboard do Jogador{% endblock %}

{% block content %}
<div class="flex flex-col h-full w-full px-6 py-4 space-y-4 text-base sm:text-lg">
  <h2 class="text-2xl sm:text-3xl font-bold text-yellow-300 mb-2">üìú Aventura em andamento</h2>

  <!-- √Årea de exibi√ß√£o dos turnos -->
  <div id="turno-historico" class="bg-gray-900 text-gray-150 p-4 rounded-lg shadow-md h-[70vh] overflow-y-auto text-sm sm:text-base">
    {% if not personagem %}
      <h2 class="text-xl sm:text-2xl font-bold text-yellow-300 mb-4">üßù‚Äç‚ôÇÔ∏è Pra come√ßar, vamos criar um personagem!</h2>
      <form method="POST" action="{{ url_for('criar_personagem') }}" class="space-y-4">
        {{ personagem_form.hidden_tag() }}
        <div>
          {{ personagem_form.nome.label(class_="text-gray-200 text-sm sm:text-base") }}
          {{ personagem_form.nome(class_="w-full p-2 rounded bg-gray-700 text-white text-sm sm:text-base") }}
        </div>
        <div>
          {{ personagem_form.classe.label(class_="text-gray-200 text-sm sm:text-base") }}
          {{ personagem_form.classe(class_="w-full p-2 rounded bg-gray-700 text-white text-sm sm:text-base") }}
        </div>
        <div>
          {{ personagem_form.raca.label(class_="text-gray-200 text-sm sm:text-base") }}
          {{ personagem_form.raca(class_="w-full p-2 rounded bg-gray-700 text-white text-sm sm:text-base") }}
        </div>
        <div>
          {{ personagem_form.descricao.label(class_="text-gray-200 text-sm sm:text-base") }}
          {{ personagem_form.descricao(class_="w-full p-2 rounded bg-gray-700 text-white text-sm sm:text-base") }}
        </div>

        <div class="grid grid-cols-3 gap-4">
          {% for attr, label in [('forca','For√ßa'),('destreza','Destreza'),('inteligencia','Intelig√™ncia')] %}
          <div>
            <label class="block text-sm sm:text-base font-medium text-gray-200">{{ label }}</label>
            <div class="flex items-center gap-2">
              <button type="button" onclick="ajustarAtributo('{{ attr }}', -1)" class="bg-gray-700 px-2 rounded text-sm sm:text-base">-</button>
              <input id="{{ attr }}" name="{{ attr }}" type="number" value="50" min="1" max="99"
                     class="w-16 text-center rounded bg-gray-700 text-white text-sm sm:text-base" readonly>
              <button type="button" onclick="ajustarAtributo('{{ attr }}', 1)" class="bg-gray-700 px-2 rounded text-sm sm:text-base">+</button>
            </div>
          </div>
          {% endfor %}
        </div>

        <p class="mt-2 text-yellow-400 font-bold text-sm sm:text-base">Pontos restantes: <span id="pontos-restantes">50</span></p>

        <div>
          <button type="submit" name="criar_personagem" class="w-full bg-green-500 text-black font-bold py-2 rounded hover:bg-green-400 transition text-sm sm:text-base">
            Criar personagem e iniciar aventura
          </button>
        </div>
      </form>
    {% else %}
      <!-- Exibi√ß√£o do hist√≥rico de mensagens -->
      <div id="turno-historico-inner">
        {% for msg in mensagens %}
          <div class="mb-4">
            <p class="text-sm sm:text-base text-gray-400">
              {{ msg.criado_em.strftime('%d/%m %H:%M') }} -
              <span class="font-bold text-yellow-400">{{ msg.autor }}</span>:
            </p>
            <p class="text-base sm:text-lg">{{ msg.mensagem }}</p>
          </div>
        {% endfor %}
      </div>
      <!-- Loader -->
      <div id="loading-turno" class="hidden flex justify-center mt-4">
        <img src="{{ url_for('static', filename='img/loading.gif') }}" alt="Carregando..." class="w-10 h-10">
      </div>
    {% endif %}
  </div>
</div>
{% endblock %}

{% block sidebar %}
<div class="relative flex flex-col h-full gap-4 p-4 bg-gray-800 rounded-xl shadow-md overflow-y-auto text-sm sm:text-base">

  <!-- Formul√°rio de entrada -->
  <form id="form-turno" method="POST" action="{{ url_for('enviar_turno') }}" class="space-y-3">
    {{ form.hidden_tag() }}
    <div>
      {{ form.acao.label(class_="text-gray-200") }}
      {{ form.acao(class_="w-full p-2 rounded-lg bg-gray-700 text-gray-200", placeholder="O que seu personagem faz?") }}
    </div>
    <div>
      {{ form.contexto.label(class_="text-gray-200") }}
      {{ form.contexto(class_="w-full p-2 rounded-lg bg-gray-700 text-gray-200", placeholder="Informa√ß√µes adicionais ao mestre...") }}
    </div>
    <div>
      {{ form.submit(class_="w-full bg-yellow-400 text-black font-bold py-2 rounded-lg hover:bg-yellow-300 transition") }}
    </div>
  </form>

  <!-- Personagens na cena -->
  <details class="bg-gray-700 rounded-md p-2 mt-2">
    <summary class="cursor-pointer font-bold text-yellow-400 text-sm sm:text-base">üé≠ Personagens na cena</summary>
    {% if personagens %}
      <ul class="list-disc list-inside ml-4 mt-2 text-sm sm:text-base">
        {% for p in personagens %}
          <li class="flex items-center gap-2">
            <input type="checkbox" name="personagem_{{ p.id }}" id="personagem_{{ p.id }}" {% if p.ativo_na_sessao %}checked{% endif %}>
            <label for="personagem_{{ p.id }}">{{ p.nome }} ({{ p.classe }})</label>
          </li>
        {% endfor %}
      </ul>
      <p class="mt-2 text-gray-300 text-xs sm:text-sm">Marque os personagens que est√£o em cena. As altera√ß√µes ser√£o registradas ao enviar o turno.</p>
    {% else %}
      <p class="text-gray-300 text-sm sm:text-base">Nenhum personagem criado.</p>
    {% endif %}
  </details>

  <!-- Acorde√µes -->
  <div class="space-y-2">
    <!-- Personagens -->
    <details class="bg-gray-700 rounded-md p-2">
      <summary class="cursor-pointer font-bold text-yellow-400 text-sm sm:text-base">üßù Personagens</summary>
      {% if personagens %}
        {% for p in personagens %}
          <div class="mb-3 border-b border-gray-600 pb-2 text-sm sm:text-base">
            <p><strong>Nome:</strong> {{ p.nome }}</p>
            <p><strong>Classe:</strong> {{ p.classe }}</p>
            <p><strong>Ra√ßa:</strong> {{ p.raca }}</p>
            <p><strong>N√≠vel:</strong> {{ p.nivel }} (XP: {{ p.xp }})</p>
            <p><strong>Atributos:</strong></p>
            <ul class="list-disc ml-4">
              {% for key, val in p.atributos.items() %}
                <li>{{ key }}: {{ val }}</li>
              {% endfor %}
            </ul>
            <p><strong>Descri√ß√£o:</strong> {{ p.descricao or '---' }}</p>
            <div class="mt-2 flex gap-2">
              <button type="button"
                      onclick="abrirModalEdicao(
                        {{ p.id }},
                        '{{ p.nome }}',
                        '{{ p.classe }}',
                        '{{ p.raca }}',
                        '{{ p.descricao|default('') }}',
                        {{ p.atributos['For√ßa'] }},
                        {{ p.atributos['Destreza'] }},
                        {{ p.atributos['Intelig√™ncia'] }}
                      )"
                      class="bg-blue-600 text-white px-3 py-1 rounded hover:bg-blue-500 text-sm sm:text-base">
                Alterar
              </button>
              <form method="POST" action="{{ url_for('excluir_personagem', personagem_id=p.id) }}"
                    onsubmit="return confirm('Tem certeza que deseja excluir este personagem?')">
                <button type="submit"
                        class="bg-red-600 text-white px-3 py-1 rounded hover:bg-red-500 text-sm sm:text-base">
                  Excluir
                </button>
              </form>
            </div>
          </div>
        {% endfor %}
      {% else %}
        <p class="text-gray-300 text-sm sm:text-base">Nenhum personagem associado.</p>
      {% endif %}
      <button onclick="document.getElementById('modal-personagem').classList.remove('hidden')" 
              class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-500 mt-2 text-sm sm:text-base">
        + Novo Personagem
      </button>
    </details>

    <!-- Invent√°rio -->
    <details class="bg-gray-700 rounded-md p-2">
      <summary class="cursor-pointer font-bold text-yellow-400 text-sm sm:text-base">üéí Invent√°rio</summary>
      {% if personagem and personagem.inventario %}
        <ul class="list-disc ml-4 text-sm sm:text-base">
          {% for item in personagem.inventario %}
            <li>{{ item }}</li>
          {% endfor %}
        </ul>
      {% else %}
        <p class="text-gray-300 text-sm sm:text-base">Sem itens.</p>
      {% endif %}
    </details>

    <!-- Aventura -->
    <details class="bg-gray-700 rounded-md p-2">
      <summary class="cursor-pointer font-bold text-yellow-400 text-sm sm:text-base">üó∫Ô∏è Aventura</summary>
      {% if aventura %}
        <p><strong>T√≠tulo:</strong> {{ aventura.titulo }}</p>
        <p><strong>Cen√°rio:</strong> {{ aventura.cenario }}</p>
        <p><strong>Status:</strong> {{ aventura.status }}</p>
        <p><strong>Resumo:</strong> {{ aventura.resumo_atual }}</p>
      {% else %}
        <p class="text-gray-300 text-sm sm:text-base">Nenhuma aventura ativa.</p>
      {% endif %}
    </details>

    <!-- Hist√≥rico -->
    <details class="bg-gray-700 rounded-md p-2">
      <summary class="cursor-pointer font-bold text-yellow-400 text-sm sm:text-base">üìö Hist√≥rico</summary>
      <p>Mensagens: {{ mensagens|length }}</p>
      <p>√öltimo turno: {{ ultima_sessao.criado_em.strftime('%d/%m %H:%M') if ultima_sessao else '---' }}</p>
    </details>
    
    <!-- Bot√£o voltar para aventuras -->
    <div class="mt-4">
      <a href="{{ url_for('lista_aventuras') }}"
         class="block w-full text-center bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded transition text-sm sm:text-base">
        ‚¨Ö Voltar para a lista de aventuras
      </a>
    </div>
  </div>

  <!-- Loader sobreposto -->
  <div id="sidebar-loading-overlay" class="hidden absolute inset-0 bg-black bg-opacity-60 flex flex-col items-center justify-center z-50">
    <img src="{{ url_for('static', filename='img/loading.gif') }}" alt="Carregando..." class="w-12 h-12 mb-2">
    <p class="text-yellow-300 text-sm font-semibold">Processando turno...</p>
  </div>
</div>

{% endblock %}

{% block scripts %}
<script>
  // ----- Modal (fecha ao clicar fora) -----
  document.addEventListener("click", function(e) {
    const modal = document.getElementById("modal-personagem");
    if (!modal) return;
    if (!modal.classList.contains("hidden") && e.target === modal) {
      modal.classList.add("hidden");
    }
  });

  // ----- Atributos (defensivo) -----
  let pontosTotais = 50;

  function atualizarPontos() {
    const forcaEl = document.getElementById("forca");
    const destrezaEl = document.getElementById("destreza");
    const inteligenciaEl = document.getElementById("inteligencia");
    if (!forcaEl || !destrezaEl || !inteligenciaEl) return 0;

    const forca = parseInt(forcaEl.value) || 50;
    const destreza = parseInt(destrezaEl.value) || 50;
    const inteligencia = parseInt(inteligenciaEl.value) || 50;

    let usados = (forca - 50) + (destreza - 50) + (inteligencia - 50);
    let restantes = pontosTotais - usados;

    const pontosElem = document.getElementById("pontos-restantes");
    if (pontosElem) pontosElem.innerText = restantes;

    return restantes;
  }

  function ajustarAtributo(id, delta) {
    const input = document.getElementById(id);
    if (!input) return;
    let valor = parseInt(input.value) || 50;
    let restantes = atualizarPontos();

    if (delta > 0 && restantes <= 0) return;
    if (delta < 0 && valor <= 1) return;
    if (delta > 0 && valor >= 99) return;

    input.value = valor + delta;
    atualizarPontos();
  }

  document.addEventListener("DOMContentLoaded", function() {
    atualizarPontos();
  });

  // ----- Abrir modal de edi√ß√£o (defensivo) -----
  function abrirModalEdicao(id, nome, classe, raca, descricao, forca, destreza, inteligencia) {
    const modal = document.getElementById('modal-personagem');
    if (!modal) return;
    modal.classList.remove('hidden');

    const setIf = (elId, value) => {
      const el = document.getElementById(elId);
      if (!el) return;
      try { el.value = value ?? ""; } catch (e) {}
    };

    setIf('personagem_id', id);
    setIf('nome', nome);
    setIf('classe', classe);
    setIf('raca', raca);
    setIf('descricao', descricao);

    setIf('forca', forca ?? 50);
    setIf('destreza', destreza ?? 50);
    setIf('inteligencia', inteligencia ?? 50);

    atualizarPontos();

    const titulo = document.getElementById('form-personagem-titulo');
    if (titulo) titulo.innerText = "Editar Personagem";
    const botao = document.getElementById('form-personagem-botao');
    if (botao) botao.innerText = "Salvar Altera√ß√µes";
  }

  // ----- AJAX para envio de turno (com loader e scroll forcing) -----
  (function() {
    const form = document.getElementById("form-turno");
    if (!form) return;

    // detecta loader ‚Äî prioriza overlay da sidebar, sen√£o loader gen√©rico
    const getLoader = () => document.getElementById("sidebar-loading-overlay") || document.getElementById("loading-turno");

    // container de mensagens e caixa de scroll
    const historicoInner = document.getElementById("turno-historico-inner");
    const historicoBox = document.getElementById("turno-historico") || historicoInner;

    form.addEventListener("submit", async function(e) {
      e.preventDefault();

      const loader = getLoader();
      // mostra loader (se existir)
      if (loader) loader.classList.remove("hidden");

      // for√ßa scroll para o final para que o usu√°rio veja o loader
      try { if (historicoBox) historicoBox.scrollTop = historicoBox.scrollHeight; } catch (err) { /* ignore */ }

      const formData = new FormData(this); // inclui csrf se estiver no hidden_tag()

      // opcional: desabilitar bot√£o de submit para evitar multi-posts
      const submitBtn = form.querySelector("button[type='submit']");
      if (submitBtn) submitBtn.disabled = true;

      try {
        const resp = await fetch("{{ url_for('enviar_turno') }}", {
          method: "POST",
          body: formData,
          headers: { "X-Requested-With": "XMLHttpRequest" }
        });

        // tenta parsear JSON (tratamento defensivo)
        let data;
        try {
          data = await resp.json();
        } catch (parseErr) {
          const txt = await resp.text().catch(()=>null);
          console.error("Resposta inv√°lida (n√£o JSON) do servidor:", parseErr, txt);
          // n√£o exibir alert ‚Äî s√≥ logar para debug
          return;
        }

        if (data && data.status === "ok") {
          // atualiza hist√≥rico
          if (historicoInner) {
            historicoInner.innerHTML = "";
            data.mensagens.forEach(msg => {
              const div = document.createElement("div");
              div.classList.add("mb-4");
              div.innerHTML = `
                <p class="text-sm sm:text-base text-gray-400">
                  ${msg.criado_em} - <span class="font-bold text-yellow-400">${escapeHtml(msg.autor)}</span>:
                </p>
                <p class="text-base sm:text-lg">${nl2br(escapeHtml(msg.mensagem))}</p>
              `;
              historicoInner.appendChild(div);
            });
          }

          // reset + foco
          this.reset();
          const acaoField = this.querySelector("[name='acao']");
          if (acaoField) {
            try { acaoField.focus(); } catch(e) {}
          }

          // for√ßa scroll para final j√° com as novas mensagens
          try { if (historicoBox) historicoBox.scrollTop = historicoBox.scrollHeight; } catch (err) {}
        } else {
          // servidor retornou status != ok ‚Äî loga pro debug
          console.error("Erro no envio do turno:", data && data.error ? data.error : data);
        }

      } catch (err) {
        console.error("Erro no fetch enviar_turno:", err);
      } finally {
        // sempre reabilita e oculta loader
        if (submitBtn) submitBtn.disabled = false;
        if (loader) loader.classList.add("hidden");
      }
    });

    // util: escapando para evitar inje√ß√£o de HTML ao inserir mensagens
    function escapeHtml(str) {
      if (str == null) return "";
      return String(str)
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    }

    // util: converte quebras de linha em <br> preservando seguran√ßa
    function nl2br(str) {
      return String(str).replace(/\r\n|\r|\n/g, "<br>");
    }
  })();
</script>
{% endblock %}

