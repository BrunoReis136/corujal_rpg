{% extends "base.html" %}

{% block title %}Dashboard do Jogador{% endblock %}

{% block content %}
<div class="flex flex-col h-full w-full px-6 py-4 space-y-4">
  <h2 class="text-3xl font-bold text-yellow-300 mb-2">üìú Aventura em andamento</h2>

  <!-- √Årea de exibi√ß√£o dos turnos -->
  <div id="turno-historico" class="bg-gray-900 text-gray-100 p-4 rounded-lg shadow-md h-[70vh] overflow-y-auto">
   {% if not personagem %}
    <h2 class="text-2xl font-bold text-yellow-300 mb-4">üßù‚Äç‚ôÇÔ∏è Pra come√ßar, vamos criar um personagem!</h2>
    <form method="POST" action="{{ url_for('criar_personagem') }}" class="space-y-4">
      {{ personagem_form.hidden_tag() }}
      <div>
        {{ personagem_form.nome.label(class_="text-gray-200") }}
        {{ personagem_form.nome(class_="w-full p-2 rounded bg-gray-700 text-white") }}
      </div>
      <div>
        {{ personagem_form.classe.label(class_="text-gray-200") }}
        {{ personagem_form.classe(class_="w-full p-2 rounded bg-gray-700 text-white") }}
      </div>
      <div>
        {{ personagem_form.raca.label(class_="text-gray-200") }}
        {{ personagem_form.raca(class_="w-full p-2 rounded bg-gray-700 text-white") }}
      </div>
      <div class="grid grid-cols-3 gap-4">
        <div>
          {{ personagem_form.forca.label(class_="text-gray-200") }}
          {{ personagem_form.forca(class_="w-full p-2 rounded bg-gray-700 text-white") }}
        </div>
        <div>
          {{ personagem_form.destreza.label(class_="text-gray-200") }}
          {{ personagem_form.destreza(class_="w-full p-2 rounded bg-gray-700 text-white") }}
        </div>
        <div>
          {{ personagem_form.inteligencia.label(class_="text-gray-200") }}
          {{ personagem_form.inteligencia(class_="w-full p-2 rounded bg-gray-700 text-white") }}
        </div>
      </div>
      <div>
        <button type="submit" name="criar_personagem" class="w-full bg-green-500 text-black font-bold py-2 rounded hover:bg-green-400 transition">
          Criar personagem e iniciar aventura
        </button>
      </div>
    </form>
  {% else %}
    <!-- Exibi√ß√£o do hist√≥rico de mensagens -->
    <div id="turno-historico" class="bg-gray-900 text-gray-100 p-4 rounded-lg shadow-md h-[70vh] overflow-y-auto">
      {% for msg in mensagens %}
        <div class="mb-4">
          <p class="text-sm text-gray-400">{{ msg.criado_em.strftime('%d/%m %H:%M') }} - <span class="font-bold text-yellow-400">{{ msg.autor }}</span>:</p>
          <p class="text-md">{{ msg.mensagem }}</p>
        </div>
      {% endfor %}
    </div>
  {% endif %}
  </div>
</div>
{% endblock %}

{% block sidebar %}
<div class="flex flex-col h-full gap-4 p-4 bg-gray-800 rounded-xl shadow-md overflow-y-auto">

  <!-- Formul√°rio de entrada -->
  <form method="POST" action="{{ url_for('enviar_turno') }}" class="space-y-3">
    {{ form.hidden_tag() }}
    <div>
      {{ form.acao.label(class_="text-gray-200") }}
      {{ form.acao(class_="w-full p-2 rounded-lg bg-gray-700 text-gray-200", placeholder="O que seu personagem faz?") }}
    </div>
    <div>
      {{ form.contexto.label(class_="text-gray-200") }}
      {{ form.contexto(class_="w-full p-2 rounded-lg bg-gray-700 text-gray-200", placeholder="Informa√ß√µes adicionais ao mestre...") }}
    </div>
    <div>
      {{ form.submit(class_="w-full bg-yellow-400 text-black font-bold py-2 rounded-lg hover:bg-yellow-300 transition") }}
    </div>
  </form>

  <!-- Acorde√µes -->
  <div class="space-y-2">

    <!-- Personagem -->
    <details class="bg-gray-700 rounded-md p-2">
      <summary class="cursor-pointer font-bold text-yellow-400">üßù Personagem</summary>
      {% if personagem %}
        <p><strong>Nome:</strong> {{ personagem.nome }}</p>
        <p><strong>Classe:</strong> {{ personagem.classe }}</p>
        <p><strong>Ra√ßa:</strong> {{ personagem.raca }}</p>
        <p><strong>N√≠vel:</strong> {{ personagem.nivel }} (XP: {{ personagem.xp }})</p>
        <p><strong>Atributos:</strong></p>
        <ul class="list-disc ml-4">
          {% for key, val in personagem.atributos.items() %}
            <li>{{ key }}: {{ val }}</li>
          {% endfor %}
        </ul>
      {% else %}
        <p class="text-gray-300">Nenhum personagem associado.</p>
      {% endif %}
      {% if personagem %}
        <button onclick="document.getElementById('modal-personagem').classList.remove('hidden')" 
                class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-500">
          + Novo Personagem
        </button>
      {% endif %}
    </details>

    <!-- Invent√°rio -->
    <details class="bg-gray-700 rounded-md p-2">
      <summary class="cursor-pointer font-bold text-yellow-400">üéí Invent√°rio</summary>
      {% if personagem and personagem.inventario %}
        <ul class="list-disc ml-4">
          {% for item in personagem.inventario %}
            <li>{{ item }}</li>
          {% endfor %}
        </ul>
      {% else %}
        <p class="text-gray-300">Sem itens.</p>
      {% endif %}
    </details>

    <!-- Aventura -->
    <details class="bg-gray-700 rounded-md p-2">
      <summary class="cursor-pointer font-bold text-yellow-400">üó∫Ô∏è Aventura</summary>
      {% if aventura %}
        <p><strong>T√≠tulo:</strong> {{ aventura.titulo }}</p>
        <p><strong>Cen√°rio:</strong> {{ aventura.cenario }}</p>
        <p><strong>Status:</strong> {{ aventura.status }}</p>
        <p><strong>Resumo:</strong> {{ aventura.resumo_atual }}</p>
      {% else %}
        <p class="text-gray-300">Nenhuma aventura ativa.</p>
      {% endif %}
    </details>

    <!-- Hist√≥rico -->
    <details class="bg-gray-700 rounded-md p-2">
      <summary class="cursor-pointer font-bold text-yellow-400">üìö Hist√≥rico</summary>
      <p>Mensagens: {{ mensagens|length }}</p>
      <p>√öltimo turno: {{ ultima_sessao.criado_em.strftime('%d/%m %H:%M') if ultima_sessao else '---' }}</p>
    </details>

  </div>
</div>

<div id="modal-personagem" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center">
  <div class="bg-gray-900 p-6 rounded-xl w-full max-w-md shadow-lg">
    <h2 class="text-xl font-bold text-yellow-400 mb-4">Criar Novo Personagem</h2>
    
    <form method="POST" action="{{ url_for('add_personagem') }}" class="space-y-4">
      {{ personagem_form.hidden_tag() }}
      <div>
        {{ personagem_form.nome.label(class="block text-sm font-medium text-gray-200") }}
        {{ personagem_form.nome(class="w-full p-2 rounded bg-gray-800 text-gray-100") }}
      </div>
      <div>
        {{ personagem_form.classe.label(class="block text-sm font-medium text-gray-200") }}
        {{ personagem_form.classe(class="w-full p-2 rounded bg-gray-800 text-gray-100") }}
      </div>
      <div>
        {{ personagem_form.raca.label(class="block text-sm font-medium text-gray-200") }}
        {{ personagem_form.raca(class="w-full p-2 rounded bg-gray-800 text-gray-100") }}
      </div>
      <div class="flex justify-end gap-2">
        <button type="button" onclick="document.getElementById('modal-personagem').classList.add('hidden')" 
                class="bg-gray-700 text-white px-4 py-2 rounded hover:bg-gray-600">
          Cancelar
        </button>
        <button type="submit" class="bg-yellow-500 text-black px-4 py-2 rounded hover:bg-yellow-400">
          Criar
        </button>
      </div>
    </form>
  </div>
</div>


{% endblock %}


{% block scripts %}
  <script>
  document.addEventListener("click", function(e) {
    const modal = document.getElementById("modal-personagem");
    if (!modal.classList.contains("hidden") && e.target === modal) {
      modal.classList.add("hidden");
    }
  });
  </script>
{% endblock %}

